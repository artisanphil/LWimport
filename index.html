<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
	<title>LearnWords</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
  	<link href="css/styles.css" rel="stylesheet">
    <script type="text/javascript" src="cordova.js"></script>
    <script src="http://192.168.1.103:8080/target/target-script-min.js#anonymous"></script>

    <script src="js/jquery-3.1.1.min.js"></script>
    <script src="js/sql.js" charset="utf-8"></script>
    <script src="fuzzy-anki/c3.min.js" charset="utf-8"></script>
    <script src="fuzzy-anki/xregexp-all-min.js" charset="utf-8"></script>
    <script src="fuzzy-anki/underscore-min.js" charset="utf-8"></script>
    <script src="fuzzy-anki/apkg.js" charset="utf-8"></script>
    <script src="js/LW.js"></script>
	<script type="text/javascript">
	window.onerror = function(errorMsg, url, lineNumber) {
	  "use strict";
	  alert(errorMsg + " " + url + " " + lineNumber);
	  return false;
	};

  var lw = LW.BoxOfQuestions(LW.LWdb('lw-storage'));

  function onLoad() {
    window.setTimeout(function() {
        var e = document.createEvent('Events');
        e.initEvent("deviceready", true, false);
        document.dispatchEvent(e);
    }, 50);
  }

  /*
  function initialize() {

    var oReq = new XMLHttpRequest();
     oReq.onload = this.reqListener;
    oReq.open("get", "data/json/german-demo.json", true);
    oReq.send();
  }

  function reqListener() {
    var wordlist = JSON.parse(this.responseText);

    console.log("wordlist:");
    console.log(wordlist);
    var tags = [];
    for(var i=0;i<wordlist.length;i++) {
      if(tags.indexOf(wordlist[i].tags) === -1) {
        tags.push(wordlist[i].tags);
        var categories = document.getElementById("categories");
        categories.innerHTML += "<div class=category><a href=\"choose-mode.html?tag=" + wordlist[i].tags + "\"><img src='data/media/" + wordlist[i].translate +"' style='max-width:100%;max-height:100%;'></a></div>";
        console.log(wordlist[i].tags);
      }
    }
    lw.db.loadWords(wordlist);
  }
  */

  function displayLessons() {
    var tag = "Nomen";
    //var wordsFilteredByTag = lw.allWordsFilteredByTag(tag);
    var wordlist = lw.db.allWords(); //lw.getLearnCards(tag);

    console.log("wordlist:");
    console.log(wordlist);
    var arrLesson = [];
    var categories = document.getElementById("categories");
    if(wordlist.length > 0) {
      for(var i=0;i<wordlist.length;i++) {
        var lesson = wordlist[i].tags.split(",")[0];
        if(arrLesson.indexOf(lesson) === -1) {
          arrLesson.push(lesson);
          //var catButton = "<div class=category>";
          var catButton = "<figure class=category><div style='display:inline-block; height:100%; vertical-align:middle;'></div><a href=\"choose-mode.html?tag=" + lesson + "\"><img src='" + cordova.file.dataDirectory + "media/" + wordlist[i].translate +"' style='max-width:100%;max-height:100%; vertical-align:middle;'></a>";
          catButton += "<figcaption>Lektion " + lesson + "</figcaption>";
          catButton += "</figure>";
          categories.innerHTML += catButton;
        }
      }
    }
    else {
      categories.innerText = "No cards found. Please find and open your .apkg file with LearnWords to import the lessons."
    }
    lw.db.loadWords(wordlist);
  }

  function fail(e) {
      console.log("FileSystem Error");
      console.dir(e);
  }

  function readFile(fileEntry) {

      fileEntry.file(function(file) {
      });
  }
  document.addEventListener('deviceready', function(){

    console.log("getting ready");
    var isCordovaApp = !!window.cordova;
    //initialize();

    var HandleIntent = function (Intent) {
         console.log(Intent.data);
         // With intent you'll do almost everything

         if(Intent.hasOwnProperty('data')){

           //ankiBinaryToTable(Intent.data);

           ankiBinaryToTable(Intent.data, function() {
             displayLessons();

           });
          // window.resolveLocalFileSystemURL(Intent.data, readFile, fail);

         }else{
           // this will happen in getCordovaIntent when the app starts and there's no
           // active intent
           console.log("The app was opened manually and there's no file to open");
         }
    };

    if(isCordovaApp)
    {
      // Handle the intent when the app is open
      // If the app is running in the background, this function
      // will handle the opened file
      window.plugins.intent.setNewIntentHandler(HandleIntent);

      // Handle the intent when the app is not open
      // This will be executed only when the app starts or wasn't active
      // in the background
      window.plugins.intent.getCordovaIntent(HandleIntent, function () {
         alert("Error: Cannot handle open with file intent");
      });
    }
    displayLessons();

  }, false);
	</script>
</head>
<body onload="onLoad();">
    <div style="vertical-align:middle; height: 8%;">
      <p style="font-weight:bold; font-size:30px; font-family:Arial;">LearnWords</p>
    </div>
    <div id=categories></div>
    <div style="height:2%;"></div>
    <progress id=importProgress style="display:none;">
</body>
</html>
